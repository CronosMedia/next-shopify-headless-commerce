'use client'

import React, { useState, useEffect, useRef, useMemo } from 'react'
import { useRouter, useSearchParams } from 'next/navigation'
import { Filter, X, ChevronDown, Check } from 'lucide-react'
import { cn } from '@/lib/utils'
import ProductCard from './ProductCard'
import DualRangeSlider from './DualRangeSlider'

// Define Product Type to match query
type Product = {
    id: string
    handle: string
    title: string
    featuredImage: {
        url: string
        altText: string
        width: number
        height: number
    } | null
    priceRange: {
        minVariantPrice: {
            amount: string
            currencyCode: string
        }
    }
    availableForSale: boolean
    variants: {
        edges: {
            node: {
                id: string
                availableForSale: boolean
            }
        }[]
    }
}

type SortOption = {
    label: string
    value: string
}

const SORT_OPTIONS: SortOption[] = [
    { label: 'Relevanță', value: 'relevance' },
    { label: 'Cele mai noi', value: 'newest' },
    { label: 'Preț (mic -> mare)', value: 'price-asc' },
    { label: 'Preț (mare -> mic)', value: 'price-desc' },
    { label: 'Cele mai vândute', value: 'best-selling' },
]

export default function CollectionProductGrid({
    initialProducts,
    collectionTitle
}: {
    initialProducts: Product[]
    collectionTitle: string
}) {
    const router = useRouter()
    const searchParams = useSearchParams()

    // State for local filtering/sorting UI
    const [products, setProducts] = useState<Product[]>(initialProducts)
    const [loading, setLoading] = useState(false)
    const [isFilterDrawerOpen, setIsFilterDrawerOpen] = useState(false)

    // Sort dropdown state
    const [isSortOpen, setIsSortOpen] = useState(false)
    const sortRef = useRef<HTMLDivElement>(null)

    // Calculate dynamic price range
    const prices = useMemo(() => products.map(p => parseFloat(p.priceRange.minVariantPrice.amount)), [products])
    const absoluteMin = useMemo(() => Math.floor(Math.min(...prices, 0)), [prices])
    const absoluteMax = useMemo(() => Math.ceil(Math.max(...prices, 1000)), [prices])

    // Current filter states
    const currentSort = searchParams.get('sort') || 'relevance'
    const [inStockOnly, setInStockOnly] = useState(false)

    // Price state maps to [min, max]
    const [priceRange, setPriceRange] = useState<[number, number]>([absoluteMin, absoluteMax])

    // Refs for scrolling to sections in drawer
    const availabilityRef = useRef<HTMLDivElement>(null)
    const priceRef = useRef<HTMLDivElement>(null)

    // Update range when products load
    useEffect(() => {
        if (initialProducts.length > 0) {
            const newPrices = initialProducts.map(p => parseFloat(p.priceRange.minVariantPrice.amount))
            const newMin = Math.floor(Math.min(...newPrices))
            const newMax = Math.ceil(Math.max(...newPrices))
            if (newMin !== absoluteMin || newMax !== absoluteMax) {
                setPriceRange([newMin, newMax])
            }
        }
    }, [initialProducts])

    // Close sort dropdown when clicking outside
    useEffect(() => {
        const handleClickOutside = (event: MouseEvent) => {
            if (sortRef.current && !sortRef.current.contains(event.target as Node)) {
                setIsSortOpen(false)
            }
        }
        document.addEventListener('mousedown', handleClickOutside)
        return () => document.removeEventListener('mousedown', handleClickOutside)
    }, [])

    // Update URL when sort changes
    const handleSortChange = (value: string) => {
        const params = new URLSearchParams(searchParams.toString())
        params.set('sort', value)
        router.push(`?${params.toString()}`, { scroll: false })
        setLoading(true)
        setIsSortOpen(false)
    }

    // Effect to re-fetch or filter products when URL params change
    useEffect(() => {
        setProducts(initialProducts)
        setLoading(false)
    }, [initialProducts])

    // Open Drawer and scroll to section
    const openFilterDrawer = (section?: 'availability' | 'price') => {
        setIsFilterDrawerOpen(true)
        // Small timeout to allow drawer to render before scrolling
        setTimeout(() => {
            if (section === 'availability' && availabilityRef.current) {
                availabilityRef.current.scrollIntoView({ behavior: 'smooth', block: 'center' })
            } else if (section === 'price' && priceRef.current) {
                priceRef.current.scrollIntoView({ behavior: 'smooth', block: 'center' })
            }
        }, 300)
    }

    // derived state for filtered products (client-side for now)
    const filteredProducts = products.filter(p => {
        if (inStockOnly && !p.availableForSale) return false

        const price = parseFloat(p.priceRange.minVariantPrice.amount)
        if (price < priceRange[0] || price > priceRange[1]) return false

        return true
    })

    const isPriceFiltered = priceRange[0] > absoluteMin || priceRange[1] < absoluteMax

    return (
        <div className="relative min-h-screen">
            {/* Horizontal Filter Bar */}
            <div className="sticky top-[60px] z-30 bg-white border-b border-gray-200 shadow-sm transition-all duration-300">
                <div className="max-w-[1600px] mx-auto px-4 md:px-8">
                    <div className="flex items-center gap-3 py-4 overflow-x-auto md:overflow-visible no-scrollbar">

                        {/* Sort Dropdown - Kept separate as standard */}
                        <div className="relative" ref={sortRef}>
                            <button
                                onClick={() => setIsSortOpen(!isSortOpen)}
                                className="flex items-center gap-2 px-5 py-2.5 bg-gray-100 hover:bg-gray-200 rounded-full text-sm font-medium whitespace-nowrap transition-colors"
                            >
                                Sortare: <span className="text-gray-900 font-bold">{SORT_OPTIONS.find(o => o.value === currentSort)?.label}</span>
                                <ChevronDown size={16} className={cn("transition-transform duration-200", isSortOpen ? "rotate-180" : "")} />
                            </button>

                            {isSortOpen && (
                                <div className="absolute top-full left-0 mt-2 w-64 bg-white rounded-xl shadow-xl border border-gray-100 py-2 z-40 animate-in fade-in zoom-in-95 duration-200">
                                    {SORT_OPTIONS.map((option) => (
                                        <button
                                            key={option.value}
                                            onClick={() => handleSortChange(option.value)}
                                            className={cn(
                                                "w-full text-left px-4 py-2 text-sm hover:bg-gray-50 flex items-center justify-between",
                                                currentSort === option.value ? "font-bold text-black" : "text-gray-600"
                                            )}
                                        >
                                            {option.label}
                                            {currentSort === option.value && <Check size={14} />}
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* Availability Trigger */}
                        <button
                            onClick={() => openFilterDrawer('availability')}
                            className={cn(
                                "flex items-center gap-2 px-5 py-2.5 border rounded-full text-sm font-medium whitespace-nowrap transition-all hover:shadow-sm",
                                inStockOnly ? "bg-black text-white border-black" : "bg-white border-gray-300 hover:border-black"
                            )}
                        >
                            Disponibilitate
                            {inStockOnly && <Check size={14} />}
                            <ChevronDown size={16} />
                        </button>

                        {/* Price Trigger */}
                        <button
                            onClick={() => openFilterDrawer('price')}
                            className={cn(
                                "flex items-center gap-2 px-5 py-2.5 bg-white border border-gray-300 hover:border-black rounded-full text-sm font-medium whitespace-nowrap transition-all hover:shadow-sm",
                                isPriceFiltered ? "bg-black text-white border-black" : ""
                            )}
                        >
                            Preț
                            {isPriceFiltered && <Check size={14} />}
                            <ChevronDown size={16} />
                        </button>

                        {/* Spacer */}
                        <div className="flex-1" />

                        {/* All Filters Trigger */}
                        <button
                            onClick={() => openFilterDrawer()}
                            className="flex items-center gap-2 px-6 py-2.5 bg-black text-white border border-black hover:bg-gray-800 rounded-full text-sm font-bold whitespace-nowrap transition-all hover:shadow-md"
                        >
                            <Filter size={16} />
                            Toate filtrele
                        </button>

                    </div>
                </div>
            </div>

            {/* Results Count */}
            <div className="max-w-[1600px] mx-auto px-4 md:px-8 py-4 text-sm text-gray-500">
                Afisare <span className="font-bold text-gray-900">{filteredProducts.length}</span> rezultate
            </div>

            {/* Product Grid */}
            <div className="max-w-[1600px] mx-auto px-4 md:px-8 pb-12">
                <div className={`relative ${loading ? 'opacity-50 pointer-events-none' : ''}`}>
                    {loading && (
                        <div className="absolute inset-0 flex h-64 items-center justify-center z-20">
                            <div className="w-8 h-8 border-2 border-black border-t-transparent rounded-full animate-spin" />
                        </div>
                    )}

                    {filteredProducts.length === 0 ? (
                        <div className="text-center py-20 bg-gray-50 rounded-lg">
                            <p className="text-gray-500">Nu am găsit produse care să corespundă criteriilor.</p>
                        </div>
                    ) : (
                        <ul className="grid grid-cols-2 lg:grid-cols-4 gap-6">
                            {filteredProducts.map((p) => (
                                <li key={p.id}>
                                    <ProductCard product={p} />
                                </li>
                            ))}
                        </ul>
                    )}
                </div>
            </div>

            {/* Filter Drawer (Sheet) */}
            {isFilterDrawerOpen && (
                <div className="fixed inset-0 z-[60] flex justify-end">
                    <div className="absolute inset-0 bg-black/50 backdrop-blur-sm" onClick={() => setIsFilterDrawerOpen(false)} />
                    <div className="relative w-full max-w-md bg-white shadow-2xl flex flex-col h-full animate-in slide-in-from-right duration-300">
                        {/* Header */}
                        <div className="flex items-center justify-between p-6 border-b">
                            <h2 className="text-2xl font-bold">Filtre</h2>
                            <button onClick={() => setIsFilterDrawerOpen(false)} className="p-2 hover:bg-gray-100 rounded-full transition-colors">
                                <X size={24} />
                            </button>
                        </div>

                        {/* Content */}
                        <div className="flex-1 overflow-y-auto p-6 space-y-10">

                            {/* Availability Section */}
                            <div ref={availabilityRef} className="scroll-mt-32">
                                <h3 className="font-bold text-lg mb-4">Disponibilitate</h3>
                                <label className="flex items-center justify-between p-4 border rounded-xl cursor-pointer hover:border-black transition-all group">
                                    <span className="font-medium text-lg group-hover:text-black">Doar în stoc</span>
                                    <input
                                        type="checkbox"
                                        checked={inStockOnly}
                                        onChange={(e) => setInStockOnly(e.target.checked)}
                                        className="w-6 h-6 rounded border-gray-300 text-black focus:ring-black"
                                    />
                                </label>
                            </div>

                            <hr className="border-gray-100" />

                            {/* Price Section */}
                            <div ref={priceRef} className="scroll-mt-32">
                                <h3 className="font-bold text-lg mb-6">Interval Preț</h3>
                                <div className="px-2 mb-6">
                                    <DualRangeSlider
                                        min={absoluteMin}
                                        max={absoluteMax}
                                        value={priceRange}
                                        onChange={setPriceRange}
                                    />
                                </div>
                                <div className="flex items-center justify-between text-base font-bold text-black">
                                    <span>{priceRange[0]} LEI</span>
                                    <span>{priceRange[1]} LEI</span>
                                </div>
                            </div>

                        </div>

                        {/* Footer */}
                        <div className="border-t p-6 bg-gray-50">
                            <button
                                onClick={() => setIsFilterDrawerOpen(false)}
                                className="w-full bg-black text-white py-4 rounded-xl font-bold text-lg hover:bg-gray-800 transition-all transform hover:scale-[1.02] active:scale-[0.98] shadow-lg"
                            >
                                Vezi {filteredProducts.length} Rezultate
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    )
}
